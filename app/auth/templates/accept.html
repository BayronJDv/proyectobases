{% extends 'layout.html' %}

{% block navbar %}

{% if current_user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-truck" viewBox="0 0 16 16">
        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5zm1.294 7.456A2 2 0 0 1 4.732 11h5.536a2 2 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456M12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
    </svg>
    <a class="navbar-brand" href="#">EasyDel</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="true" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
        <li class="nav-item active">
            <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('authentication.accept')}}">Aceptar servicios</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('authentication.myservices')}}">Mis Servicios en curso</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Cuenta
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="{{ url_for('authentication.log_out_user')}}">cerrar sesion</a>
            <a class="dropdown-item" href="#">MI informacion</a>
            <a class="dropdown-item" href="{{ url_for('authentication.delete')}}">Borrar Cuenta</a>
            </div>
        </li>
        </ul>
    </div>
    </nav>
{% else %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-truck" viewBox="0 0 16 16">
        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5zm1.294 7.456A2 2 0 0 1 4.732 11h5.536a2 2 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456M12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
    </svg>
    <a class="navbar-brand" href="#">EasyDel</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="true" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
        <li class="nav-item active">
            <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('authentication.log_in_user')}}">Iniciar Sesion </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('authentication.homepagem')}}">Mis Acciones</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Registrarse
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="{{ url_for('authentication.register_user') }}">Registrar Usuario</a>
            <a class="dropdown-item" href="{{ url_for('authentication.register_client') }}">Registrar Cliente</a>
            <a class="dropdown-item" href="{{ url_for('authentication.register_delivery') }}">Registrar Mensajero</a>
            </div>
        </li>
        </ul>
    </div>
    </nav>

    {%endif%}
{% endblock %}
{% block content %}
 <div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-9">
            {% for pedido in pedidos %}
            <div class="card">
                <div class="card-header">
                codigo de pedido : {{pedido.Codigo}}
                </div>
                <div class="card-body">
                    <h5 class="card-title">Desde {{ pedido.Origen }}, hasta {{ pedido.Destino }}</h5>
                    <h6 class="card-subtitle mb-2 text-body-secondary">{{ pedido.NumPaquetes }} paquete(s) en {{ pedido.TipoTransporte }}</h6>
                    <p class="card-text">{{ pedido.Descripcion }}</p>
                    <button class="btn btn-primary aceptar-btn" data-codigo="{{ pedido.Codigo }}" data-nume="2" data-usuario="{{ current_user.id }}">Aceptar</button>
                    <input type="file" class="file-input" style="display: none;" accept="image/*">
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $('.entregar-btn').on('click', function() {
            var button = $(this);
            var cardBody = button.closest('.card-body');
            var fileInput = cardBody.find('.file-input');

            fileInput.click();  // Iniciar la GUI de selección de archivo

            fileInput.on('change', function() {
                var file = fileInput[0].files[0];
                if (!file) {
                    alert('Por favor, seleccione una imagen.');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // Convertir la imagen a JPEG
                        var foto = canvas.toDataURL('image/jpeg').split(',')[1];  // Obtener la parte de datos base64
                        var codigo = button.data('codigo');
                        var nume = button.data('nume');
                        var usuario = button.data('usuario');

                        $.ajax({
                            url: "/change_estado",
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ codigo: codigo, nume: nume, foto: foto, usuario: usuario }),
                            success: function(response) {
                                alert(response.message);
                                location.reload();  // Recarga la página sin cambiar la URL
                            },
                            error: function(error) {
                                alert('Error al aceptar el pedido');
                            }
                        });
                    };
                };

                reader.readAsDataURL(file);
            });
        });
    });
</script>

 </div>

 {% endblock content%}